import "@fontsource/raleway/index.css";
import Fathom from "@peated/web/components/fathom";
import config from "@peated/web/config";
import "@peated/web/styles/index.css";
import * as Sentry from "@sentry/react";
import {
  createRootRoute,
  HeadContent,
  Outlet,
  Scripts,
} from "@tanstack/react-router";
import React from "react";
import useAuth from "../hooks/useAuth";
import Providers from "./providers/providers";

// export const viewport: Viewport = {
//   width: "device-width",
//   initialScale: 1,
//   maximumScale: 1.0,
//   userScalable: false,
//   themeColor: config.THEME_COLOR,
// };

export const Route = createRootRoute({
  head: () => ({
    meta: [
      { charSet: "utf-8" },
      {
        name: "viewport",
        content:
          "width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no",
      },
      { title: "Peated", description: config.DESCRIPTION },
      // ...Sentry.getTraceData(),
      // openGraph: {
      //   siteName: "Peated",
      // },
    ],
  }),
  component: RootLayout,
});

function RootLayout({
  children,
  // auth,
}: Readonly<{
  children: React.ReactNode;
  // auth: React.ReactNode;
}>) {
  const { user, accessToken } = useAuth();
  // let session = await getSession();

  // we need to bind the user on the server, but we also do this in providers
  // so it stays updated on the client appropriately
  Sentry.setUser(
    user
      ? {
          id: `${user.id}`,
          username: user.username,
          email: user.email,
        }
      : null,
  );

  return (
    <html lang="en">
      <head>
        <HeadContent />
      </head>
      <body className="h-full">
        <Providers
          session={{
            user: user,
            accessToken: accessToken,
          }}
        >
          <Outlet />
          <Scripts />
          {config.FATHOM_SITE_ID && (
            <Fathom
              siteId={config.FATHOM_SITE_ID}
              includedDomains={["peated.com"]}
            />
          )}
        </Providers>
      </body>
    </html>
  );
}